# Как загружать данные в систему

1. [Базовая структура каталогов](#Базовая-структура-каталогов)
1. [Исполнение команды make_migrations](#Исполнение-команды-make_migrations)
1. [Исполнение команды migrate](#Исполнение-команды-migrate)
1. [Исполнение команды relocate](#Исполнение-команды-relocate)
1. [Исполнение команды sync](#Исполнение-команды-sync)
1. [Исполнение команды freeze](#Исполнение-команды-freeze)

## Базовая структура каталогов

Система состоит из двух базовых сущностей — каталог исходных данных и каталог
обработанных данных.

Каталог исходных данных:

```
sources/
├── source_1/
│   ├── migration_1/
│   │   ├── group_1/
│   │   ├── group_2/
│   │   ├── no_group/
│   │   ├── leaf.db
│   │   ├── source.json
│   │   ├── update.json
│   │   ├── relocation.json
│   │   └── migration.sql
│   ├── migration_2/
│   │   ├── group_3/
│   │   ├── group_4/
│   │   ├── no_group/
│   │   ├── leaf.db
│   │   ├── source.json
│   │   ├── update.json
│   │   ├── relocation.json
│   │   └── migration.sql
│   └── trunk.db
├── source_2/
│   ├── migration_3/
│   │   ├── group_5/
│   │   ├── group_6/
│   │   ├── no_group/
│   │   ├── leaf.db
│   │   ├── source.json
│   │   ├── update.json
│   │   ├── relocation.json
│   │   └── migration.sql
│   └── trunk.db
└── root.db
```

Есть коневой каталог, называемый sources, в котором находится или будет
находиться корневой файл базы данных root.db. В корневом каталоге находятся
несколько стволовых каталогов, в каждом из которых находятся базы trunk.db. В
каждом из них находятся несколько листовых каталогов.

Основная работа производится в листовых каталогах, в них генерируются все
исходные данные и из них они попадают в основную баз данных.

Каталог обработанных данных:

```
content/
├── realm_1/
│   └── theme_1/
│       └── group_1/
│           └──ed4e1ad9-9c7d-450a-8dc6-fc8abdd0ca7b.jpg
├── realm_2/
│   └── theme_2/
│       └── group_2/
│           └──ed4e1ad9-9c7d-450a-8dc6-fc8abdd0ca3b.jpg
└── database.db
```

В каталоге обработанных данных хранится файл database.db, оптимизированный под
поиск по тегам и сами данные пользователей.

## Исполнение команды make_migrations

Эта команда анализирует исходные данные и в каждом листовом каталоге генерирует
файлы:

- **update.json** - тут хранятся обработанные входные данные. Они доводятся до
  состояния почти полной готовности к сохранению в базу данных. Это
  промежуточный этап обработки, перед генерацией самих SQL команд.
- **relocation.json** - тут хранится список операций над файлами, которые надо
  выполнить, чтобы сгенерировались все необходимые промежуточные варианты
  данных. Например, изображения для предпросмотра.
- **migration.sql** - тут хранятся непосредственные SQL команды для сохранения
  данных.
- **leaf.db** - это маленькая база данных, куда сохраняются данные текущего
  листа.

Более подробно формат исходных данных описан
в [Формат исходных данных](./source.md)

## Исполнение команды relocate

Эта команда выполняет сохранение медиа файлов из их исходного каталога в
каталог с контентом. Попутно генерируются варианты для предпросмотра.

## Исполнение команды relocate

Эта команда выполняет сохранение медиа файлов из их исходного каталога в
каталог с контентом. Попутно генерируются варианты для предпросмотра.

## Исполнение команды relocate

Эта команда выполняет сохранение медиа файлов из их исходного каталога в
каталог с контентом. Попутно генерируются варианты для предпросмотра.

## Исполнение команды migrate

Это команда читает файлы **migration.sql** и накатывает все операции из них в
базу данных leaf.db.

## Исполнение команды sync

Эта команда накатывает все данные из локального leaf.db в локальный trunk.db.
Потом из trunk.db накатывает в root.db.

## Исполнение команды freeze

Эта команда генерирует индексы и собирает из root.db финальный вариант файла
database.db, который уже может использоваться приложением. 